@page "/BegeleiderProfile"
@using Gatam.Application.CQRS
@using Gatam.WebAppVolger.Extensions
@using Gatam.WebAppVolger.Components.Layout
@inject ApiClient ApiClient
@inject IHttpContextAccessor HttpContextAccessor
@attribute [Authorize]
<InactiveUserRedirect />

<h3>Mijn Begeleider</h3>

@if (_isLoading)
{
    <div class="text-center">
        <Spinner Type="SpinnerType.Dots" Color="SpinnerColor.Primary" Size="SpinnerSize.ExtraLarge" />
    </div>
}
else if (_hasError)
{
    <Callout Color="CalloutColor.Danger">
        <strong>Error:</strong> Er is een probleem opgetreden bij het ophalen van jouw begeleider.
    </Callout>
}
else if (_begeleider != null)
{
    <div class="card mb-3">
        <div class="card-body">
            <h5>@_begeleider.Nickname</h5>
            <p>Email: @_begeleider.Email</p>
            <p>Telefoon: @_begeleider.PhoneNumber</p>
        </div>
    </div>
}
else
{
    <div class="text-center">
        <p>Geen begeleider gevonden voor jouw account.</p>
    </div>
}

@code {
    private UserDTO _begeleider;
    private bool _isLoading = true;
    private bool _hasError = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadBegeleider();
    }

    private async Task LoadBegeleider()
    {
        _isLoading = true;
        try
        {
            if (HttpContextAccessor.HttpContext?.User.Identity?.IsAuthenticated == true)
            {
                var userId = HttpContextAccessor.HttpContext.User.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value;
                if (string.IsNullOrEmpty(userId))
                {
                    _hasError = true;
                    return;
                }

                _begeleider = await ApiClient.GetFromJsonAsync<UserDTO>($"api/user/{userId}/begeleider");
            }
            else
            {
                _hasError = true;
            }
        }
        catch (HttpRequestException ex)
        {
            _hasError = true;
        }
        catch (Exception ex)
        {
            _hasError = true;
        }
        finally
        {
            _isLoading = false;
        }
    }

}
