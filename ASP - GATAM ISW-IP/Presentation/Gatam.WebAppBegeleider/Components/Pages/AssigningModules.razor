@page "/content/AssigningModules"
@using Gatam.Application.CQRS.DTOS.ModulesDTO
@using Gatam.Domain
@using Gatam.WebAppBegeleider.Extensions
@using Gatam.WebAppBegeleider.Components.Layout
@inject ApiClient ApiClient
@rendermode InteractiveServer
@attribute [Authorize(Policy = "RequireManagementRole")]
<CustomCards>
    <div class="card-body">
        <div class="card-header">
            <h5>Wijs Modules toe aan Volgers</h5>
        </div>

        @if (IsLoading)
        {
            <div class="text-center">
                <Spinner Class="me-3" Type="SpinnerType.Dots" Color="SpinnerColor.Primary" Size="SpinnerSize.ExtraLarge" />
            </div>
        }
        else
        {
            <div class="mb-3">
                <label>Selecteer Volger:</label>
                <select class="form-select" @onchange="OnVolgerSelected">
                    <option value="">-- Selecteer een Volger --</option>
                    @foreach (var volger in VolgersWithModules)
                    {
                        <option value="@volger.Id">@volger.Email (@volger.Id)</option>
                    }
                </select>
            </div>

            <div class="mb-3">
                <label>Selecteer Module:</label>
                <select class="form-select" @onchange="OnModuleSelected">
                    <option value="">-- Selecteer een Module --</option>
                    @foreach (var module in Modules)
                    {
                        <option value="@module.Id">@module.Title</option>
                    }
                </select>
            </div>

            <button @onclick="AssignModuleToVolger" class="btn btn-primary mt-2"
                    disabled="@(string.IsNullOrEmpty(SelectedVolgerId) || string.IsNullOrEmpty(SelectedModuleId))">
                Wijs Module toe
            </button>

            @if (!string.IsNullOrEmpty(SuccessMessage))
            {
                <div class="alert alert-success mt-3">@SuccessMessage</div>
            }
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger mt-3">@ErrorMessage</div>
            }

            <hr />

            <h5>Volgers en Toegewezen Modules</h5>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Volger ID</th>
                            <th>Toegewezen Modules</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (VolgersWithModules.Count == 0)
                        {
                            <tr>
                                <td colspan="3" class="text-center">Geen volgers gevonden.</td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var volger in VolgersWithModules)
                            {
                                <tr>
                                    <td>@volger.Email</td>
                                    <td>@volger.Id</td>
                                    <td>
                                        @if (volger.Modules != null && volger.Modules.Count > 0)
                                        {
                                            <ul class="list-unstyled">
                                                @foreach (var module in volger.Modules)
                                                {
                                                    <li>@module</li>
                                                }
                                            </ul>
                                        }
                                        else
                                        {
                                            <span>Geen modules toegewezen</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</CustomCards>

@code {
    private List<UserWithModulesDTO> VolgersWithModules = new();
    private List<ApplicationModule> Modules = new();
    private string SelectedVolgerId;
    private string SelectedModuleId;
    private string? SuccessMessage;
    private string? ErrorMessage;
    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        IsLoading = true;
        await LoadVolgersWithModules();
        await LoadModules();
        IsLoading = false;
    }

    private async Task LoadVolgersWithModules()
    {
        VolgersWithModules = await ApiClient.GetFromJsonAsync<List<UserWithModulesDTO>>("api/user/usersWithModules") ?? new List<UserWithModulesDTO>();
    }

    private async Task LoadModules()
    {
        Modules = await ApiClient.GetFromJsonAsync<List<ApplicationModule>>("api/module") ?? new List<ApplicationModule>();
    }

    private async Task AssignModuleToVolger()
    {
        if (string.IsNullOrEmpty(SelectedVolgerId) || string.IsNullOrEmpty(SelectedModuleId))
        {
            ErrorMessage = "Selecteer zowel een volger als een module.";
            SuccessMessage = null;
            return;
        }

        var response = await ApiClient.PutAsJsonAsync($"api/user/AssignUserModule/{SelectedVolgerId}?moduleId={SelectedModuleId}", new { });

        if (response.IsSuccessStatusCode)
        {
            SuccessMessage = "Module succesvol toegewezen!";
            ErrorMessage = null;
            await LoadVolgersWithModules();
        }
        else
        {
            ErrorMessage = "Het toewijzen van de module is mislukt.";
            SuccessMessage = null;
        }
    }

    private void OnVolgerSelected(ChangeEventArgs e)
    {
        SelectedVolgerId = e.Value?.ToString();
    }

    private void OnModuleSelected(ChangeEventArgs e)
    {
        SelectedModuleId = e.Value?.ToString();
    }
}
