﻿
@page "/content/AssigningModules"
@using Gatam.Application.CQRS
@using Gatam.Application.CQRS.DTOS.ModulesDTO
@using Gatam.Domain
@using Gatam.WebAppBegeleider.Extensions
@using System.Diagnostics
@inject ApiClient ApiClient
@rendermode InteractiveServer
@inject AuthenticationStateProvider authStateProvider

@attribute [Authorize(Policy = "RequireManagementRole")]

<link href="css/assigning-modules.css" rel="stylesheet" />

<CustomCards>
    <div class="card-body">
        <div class="card-header">
            <h5>Wijs Modules toe aan Gebruikers</h5>
        </div>

        @if (IsLoading)
        {
            <div class="text-center">
                <Spinner Class="me-3" Type="SpinnerType.Dots" Color="SpinnerColor.Primary" Size="SpinnerSize.ExtraLarge" />
            </div>
        }
        else
        {
            <div class="mb-3">
                <label>Selecteer Gebruiker:</label>
                <select class="form-select" @onchange="OnUserSelected">
                    <option value="">-- Selecteer een Gebruiker --</option>
                    @foreach (var user in users)
                    {
                        <option value="@user.Id">@user.Email (@user.Id)</option>
                    }
                </select>
            </div>

            <div class="mb-3">
                <label>Selecteer Module:</label>
                <select class="form-select" @onchange="OnModuleSelected">
                    <option value="">-- Selecteer een Module --</option>
                    @foreach (var module in modules)
                    {
                        <option value="@module.Id">@module.Title</option>
                    }
                </select>
            </div>

            <button @onclick="AssignModuleToUser" class="btn btn-primary mt-2"
                    disabled="@(string.IsNullOrEmpty(SelectedUserId) || string.IsNullOrEmpty(SelectedModuleId))">
                Wijs Module toe
            </button>

            @if (!string.IsNullOrEmpty(SuccessMessage))
            {
                <div class="alert alert-success mt-3">@SuccessMessage</div>
            }
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger mt-3">@ErrorMessage</div>
            }


            <Accordion>
                <AccordionItem>
                    <TitleTemplate>
                        <Icon Name="IconName.Person" Class="me-1" /> Selecteer een volger
                          
                    </TitleTemplate>
                    <Content>
                        <Grid TItem="UserDTO"
                              @ref="userGrid"
                              Data="@users"
                              AllowFiltering="true"
                              AllowSorting="true"
                              AllowPaging="true"
                              PageSize="10"
                              ShowPager="true"
                              Responsive="true"
                              Class="table table-hover">
                            <GridColumns>
                                <GridColumn TItem="UserDTO"
                                            HeaderText="Naam"
                                            PropertyName="Name"
                                            SortKeySelector="@(item => item.Name)">
                                    @context.Name
                                </GridColumn>
                                <GridColumn TItem="UserDTO"
                                            HeaderText="Achternaam"
                                            PropertyName="Surname"
                                            SortKeySelector="@(item => item.Surname)">
                                    @context.Surname
                                </GridColumn>
                                <GridColumn TItem="UserDTO"
                                            HeaderText="Email"
                                            PropertyName="Email"
                                            SortKeySelector="@(item => item.Email)">
                                    @context.Email
                                </GridColumn>
                                <GridColumn TItem="UserDTO" HeaderText="Selecteren">
                                    <button class="btn btn-primary" @onclick="@(() => SelectUser(context.Id))">Selecteer Gebruiker</button>
</GridColumn>
                            </GridColumns>
                        </Grid>
                        @if (!string.IsNullOrEmpty(SelectedUserId))
                        {
                            <p>Geselecteerde volger: <strong>@users.FirstOrDefault(m => m.Id == SelectedUserId)?.Name @users.FirstOrDefault(m => m.Id == SelectedUserId)?.Surname</strong></p>
                        }
                    </Content>

                </AccordionItem>
                <AccordionItem>
                    <TitleTemplate>
                       <Icon Name="IconName.Book" Class="me-1" /> Selecteer een module
                    </TitleTemplate>
                    <Content>
                        <Grid TItem="ApplicationModule"
                              @ref="moduleGrid"
                              Data="@modules"
                              AllowFiltering="true"
                              AllowSorting="true"
                              AllowPaging="true"
                              PageSize="10"
                              ShowPager="true"
                              Responsive="true"
                              Class="table table-hover">
                            <GridColumns>
                                <GridColumn TItem="ApplicationModule" HeaderText="Titel" PropertyName="Title">
                                    @context.Title
                                </GridColumn>
                                <GridColumn TItem="ApplicationModule" HeaderText="Categorie" PropertyName="Category">
                                    @context.Category
                                </GridColumn>
                                <GridColumn TItem="ApplicationModule" HeaderText="Selecteren">
    <button class="btn btn-primary" @onclick="@(() => SelectModule(@context.Id))">
        Selecteer Module
    </button>
</GridColumn>
                            </GridColumns>
                        </Grid>

                        @if (!string.IsNullOrEmpty(SelectedModuleId))
                        {
                            <p>Geselecteerde module: <strong>@modules.FirstOrDefault(m => m.Id == SelectedModuleId)?.Title</strong></p>
                        }

                    </Content>
                </AccordionItem>
            </Accordion>

        }
    </div>
</CustomCards>

@code {
    private List<UserWithModulesDTO> UsersWithModules = new();
    private List<UserDTO> users = new();
    private List<ApplicationModule> modules = new();
    private string SelectedUserId = "";
    private string SelectedModuleId= "";
    private string? SuccessMessage;
    private string? ErrorMessage;
    private bool IsLoading = true;

    private Grid<UserDTO> userGrid = new();
    private Grid<ApplicationModule> moduleGrid = new();



    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;
        try
        {
            users = await ApiClient.GetFromJsonAsync<List<UserDTO>>("api/user") ?? new(); modules = await ApiClient.GetFromJsonAsync<List<ApplicationModule>>("api/module") ?? new();
            var authState = await authStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (users != null && users.Count > 0)
            {
               users = users.Where(u => u.BegeleiderId == userId)
                    .ToList();
            }
            
        }
        catch (Exception ex)
        {
            ErrorMessage = "Er is een fout opgetreden bij het laden van de data.";
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task AssignModuleToUser()
    {
        if (string.IsNullOrEmpty(SelectedUserId) || string.IsNullOrEmpty(SelectedModuleId))
        {
            ErrorMessage = "Selecteer zowel een gebruiker als een module.";
            SuccessMessage = null;
            return;
        }

        var response = await ApiClient.PutAsJsonAsync($"api/user/AssignUserModule/{SelectedUserId}?moduleId={SelectedModuleId}", new { });

        if (response.IsSuccessStatusCode)
        {
            SuccessMessage = "Module succesvol toegewezen!";
            ErrorMessage = null;
            await OnInitializedAsync();
        }
        else
        {
            var content = await response.Content.ReadAsStringAsync();
            ErrorMessage = "Het toewijzen van de module is mislukt.";
            SuccessMessage = null;
        }
    }

    private void OnUserSelected(ChangeEventArgs e)
    {
        SelectedUserId = e.Value?.ToString();
    }

    private void OnModuleSelected(ChangeEventArgs e)
    {
        SelectedModuleId = e.Value?.ToString();
    }
    private void SelectUser(string userId)
    {
        SelectedUserId = userId;
    }
    private void SelectModule(string moduleId)
    {
        SelectedModuleId = moduleId;
    }


}
